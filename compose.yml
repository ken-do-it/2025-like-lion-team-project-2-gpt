services:
  backend:
    build:
      context: ./team_2_music_back
      dockerfile: Dockerfile
    container_name: music-backend
    env_file:
      - ./team_2_music_back/.env
    volumes:
      - ./team_2_music_back/storage:/app/storage
    environment:
      # DB 연결: compose 내부 postgres 서비스를 기본값으로 사용
      MUSIC_DATABASE_URL: postgresql+psycopg://music_user:music_pass@db:5432/music_db
      # S3 사용 시 필요한 값들(.env에서도 override 가능)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-ap-northeast-2}
    ports:
      - "8001:8001"
    # 개발용 커맨드 예시(참고): uvicorn main:app --host 0.0.0.0 --port 8001 --reload
    command: >
      uvicorn main:app --host 0.0.0.0 --port 8001
    restart: unless-stopped
    depends_on:
      - db

  nginx:
    image: nginx:1.27
    container_name: music-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend

  db:
    image: postgres:16
    container_name: music-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: music_user
      POSTGRES_PASSWORD: music_pass
      POSTGRES_DB: music_db
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      # 호스트에서 65432로 접속하고 컨테이너 내부 5432로 전달
      - "65432:5432"

volumes:
  db-data:
